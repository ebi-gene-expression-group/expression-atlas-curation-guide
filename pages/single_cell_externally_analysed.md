# Curating externally analysed datasets

Data provided to the Gene Expression Team which were processed by other teams (and provided in annData format) require another level of curation in order to understand that processing sufficiently for integration into Single Cell Expression Atlas. This information will then be used to complete the configuration file as required by [atlas-anndata](https://github.com/ebi-gene-expression-group/atlas-anndata).

The following information should be gathered in addition to standard fields.

## Analysis methods

At a minimum we need:

 * Mapping/ quantification tool (e.g. CellRanger) and version. 
 * Ensembl genome / transcriptome version used. This is frequently a product of the reference supplied and used by CellRanger, but is important for us to understand any differences in gene sets etc relative to other SCXA datasets.

## Matrix processing operations

annData files can contain multiple matrices derived from different levels of processing. They will be stored in `.X` as well as possibly `.raw.x` and `.layers[]` of the object.
 
Some of those processes can be destrutive, and remove the information required for any augmented analysis we may undertake (e.g. marker detection). Is therefore crucial for us to have the following information for each matrix in the above slots:

 - Have cells been filtered out? By what criteria? (This is usually true, since the matrices in annData objects must all pertain to the same set of cells.
 - Have genes been filtered out? By what criteria? Where present, `.raw.X` may sometimes contain a matrix before any gene filtering has been applied.
 - Have values been normalised? How?
 - Has a log transform been applied? How? 
 - Has any additional scaling been applied?

### Which matrix is suitable for loading to SCXA, marker detection etc?

We ideally want a filtered and normalised matrix, with or without a log transform (we can reverse the transform dynamically as we process the annDAta file). If any destructive scaling has been applied this is harder for us to work with.

The index of .var that belongs to the matrix for Atlas loading must be the Ensembl ID. Otherwise, it will cause errors in the later processing step.

## Cell annotation fields

Which fields from the cell annotation tables should be passed to curation? annData objects contain a variety of fields derived from analysis that may not be suitatble for curation. It may simplify matters if they are flagged as 'analysis' rather than curation for [atlas-anndata](https://github.com/ebi-gene-expression-group/atlas-anndata), so that they are not passed to the pre-MAGETAB files generated by that package.

## Questionnaire for submitters:

This questionnaire should be sent to submitters before we start processing their anndata, to ensure the anndata meets our requirements.

* Which Ensembl reference version was used? Please provide genome build and annotation version. For example `hg38, Ensembl version 106`. 
* What tools (and versions) were used for mapping and quantification? For example `CellRanger version 1.0`
* Please make sure a filtered, normalised and untransformed matrix included in the anndata object, and the index of the corresponding .var is Ensembl ID. Which matrix is it?
* For each matrix present in the annData object (under .X, .raw.X and .layers):
    - Have cells been filtered out? By what criteria? (This is usually true, since the matrices in annData objects must all pertain to the same set of cells.
    - Have genes been filtered out? By what criteria? Where present, `.raw.X` may sometimes contain a matrix before any gene filtering has been applied.
    - Have values been normalised? How?
    - Has a log transform been applied? How? 
    - Has any additional scaling been applied?
* If the data processing has been described in a publication or preprint, please provide url/doi.
